# Extension Architecture

This document explains the technical architecture of the LaTeX to Typst VS Code extension.

## Overview

The extension uses a WASM-based Rust library for conversion, wrapped in a TypeScript VS Code extension API.

```
┌─────────────────────────────────────────────────────────┐
│                    VS Code Extension                    │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌───────────────┐         ┌──────────────┐           │
│  │  extension.ts │────────▶│ WASM Module  │           │
│  │  (TypeScript) │         │ (Rust/WASM)  │           │
│  └───────────────┘         └──────────────┘           │
│         │                         │                    │
│         │                         │                    │
│         ▼                         ▼                    │
│  ┌───────────────────────────────────────┐            │
│  │      latex2typst Rust Library         │            │
│  │  ┌─────────┐  ┌────────┐  ┌────────┐ │            │
│  │  │ Parser  │─▶│  AST   │─▶│Converter│            │
│  │  └─────────┘  └────────┘  └────────┘ │            │
│  └───────────────────────────────────────┘            │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

## Components

### 1. Rust Library (`../src/`)

**Purpose**: Core conversion logic

**Key Files**:
- `lib.rs` - Public API
- `parser/` - LaTeX and Markdown parsers
- `ast/` - Abstract syntax tree definitions
- `converter/` - Typst output generator
- `wasm.rs` - WASM bindings

**API Exposed to WASM**:
```rust
// Simple conversions
pub fn convert_to_typst(input: String) -> Result<String, JsValue>
pub fn latex_to_typst(input: String) -> Result<String, JsValue>
pub fn markdown_to_typst(input: String) -> Result<String, JsValue>

// Advanced converter with config
pub struct WasmConverter
impl WasmConverter {
    pub fn new() -> Self
    pub fn withConfig(strict: bool, preserve_comments: bool) -> Self
    pub fn convert(input: String, format: String) -> Result<String, JsValue>
}

// Utilities
pub fn detect_format(input: String) -> String
pub fn version() -> String
```

### 2. WASM Package (`wasm/`)

**Purpose**: Bridge between Rust and JavaScript

**Generated by**: `wasm-pack build --target nodejs`

**Files**:
- `latex2typst.js` - JavaScript bindings
- `latex2typst_bg.wasm` - WebAssembly binary
- `latex2typst.d.ts` - TypeScript type definitions
- `package.json` - NPM package metadata

**Loading in Extension**:
```typescript
const wasmModule = require('./wasm/latex2typst.js');
// Use wasmModule.convert_to_typst(), etc.
```

### 3. Extension (`src/extension.ts`)

**Purpose**: VS Code integration

**Architecture**:

```typescript
// Initialization
async function activate(context: vscode.ExtensionContext) {
    await initializeWasm();  // Load WASM module
    registerCommands();      // Register commands
    setupStatusBar();        // Setup UI
}

// Command handlers
async function convertSelection()
async function convertFile()
async function convertAndSave()
async function showPreview()

// Core conversion
function convertToTypst(input: string, format: string): string {
    if (useConfig) {
        const converter = wasm.WasmConverter.withConfig(...);
        return converter.convert(input, format);
    } else {
        return wasm.convert_to_typst(input);
    }
}
```

## Data Flow

### Convert Selection Flow

```
1. User selects text in editor
2. User runs "Convert Selection" command
3. Extension gets selected text
4. Extension calls convertToTypst(text, format)
5. WASM module converts to Typst
6. Extension replaces selection with result
7. User sees Typst output
```

### Convert and Save Flow

```
1. User runs "Convert and Save" command
2. Extension gets entire document text
3. Extension calls convertToTypst(text, format)
4. Extension shows save dialog
5. User chooses filename
6. Extension writes Typst to new file
7. Extension opens new file in editor
```

## Configuration

Settings are stored in VS Code workspace configuration:

```json
{
  "latex2typst.autoDetectFormat": true,
  "latex2typst.strictMode": false,
  "latex2typst.preserveComments": false,
  "latex2typst.autoSaveOnConvert": false
}
```

Accessed via:
```typescript
const config = vscode.workspace.getConfiguration('latex2typst');
const autoDetect = config.get<boolean>('autoDetectFormat', true);
```

## Command Registration

Commands are registered in `package.json`:

```json
{
  "contributes": {
    "commands": [
      {
        "command": "latex2typst.convertSelection",
        "title": "LaTeX to Typst: Convert Selection"
      }
    ]
  }
}
```

And implemented in TypeScript:

```typescript
context.subscriptions.push(
    vscode.commands.registerCommand(
        'latex2typst.convertSelection',
        convertSelection
    )
);
```

## UI Integration

### Status Bar

Shows `LaTeX→Typst` when editing Markdown or LaTeX files.

```typescript
const statusBarItem = vscode.window.createStatusBarItem(
    vscode.StatusBarAlignment.Right, 100
);
statusBarItem.command = 'latex2typst.convertFile';
```

### Context Menu

Right-click on selection shows "Convert Selection".

Configured in `package.json`:
```json
{
  "menus": {
    "editor/context": [{
      "command": "latex2typst.convertSelection",
      "when": "editorHasSelection"
    }]
  }
}
```

### Command Palette

All commands available via `Cmd+Shift+P`.

## Error Handling

```typescript
try {
    const typst = convertToTypst(text, format);
    // Success
} catch (error) {
    vscode.window.showErrorMessage(
        `Conversion failed: ${error.message}`
    );
}
```

Errors from Rust are converted to JavaScript errors via WASM bindings:

```rust
#[wasm_bindgen]
pub fn convert_to_typst(input: String) -> Result<String, JsValue> {
    convert(&input)
        .map_err(|e| JsValue::from_str(&e.to_string()))
}
```

## Build Process

### Development Build

```bash
# 1. Build WASM (from project root)
wasm-pack build --target nodejs --features wasm
# Copy files from pkg/ to vscode-extension/wasm/

# 2. Install dependencies (from vscode-extension/)
pnpm install

# 3. Compile TypeScript
pnpm run compile
```

### Production Build

```bash
# Build and package
pnpm run setup
pnpm run package

# Creates: latex2typst-converter-0.1.0.vsix
```

## Testing Strategy

### Manual Testing

1. Open extension in debug mode (F5)
2. Test each command with sample files
3. Verify error handling
4. Check configuration changes

### Automated Testing (Future)

```typescript
// tests/suite/extension.test.ts
import * as assert from 'assert';
import * as vscode from 'vscode';

suite('Extension Test Suite', () => {
    test('Convert simple markdown', async () => {
        const result = await vscode.commands.executeCommand(
            'latex2typst.convert',
            '# Hello'
        );
        assert.strictEqual(result, '= Hello');
    });
});
```

## Performance Considerations

### WASM Loading

- WASM module is loaded once on activation
- Subsequent conversions are fast (no re-initialization)
- Binary is ~270KB, loads in milliseconds

### Conversion Speed

- Typical document (< 1000 lines): < 10ms
- Large document (10000 lines): < 100ms
- WASM is compiled, so very fast

### Memory Usage

- WASM module: ~1-2 MB in memory
- Extension overhead: ~5-10 MB
- Minimal compared to typical VS Code extensions

## Security

- No network access required
- All conversion happens locally in WASM
- No external dependencies at runtime
- Input sanitization handled by Rust parser
- WASM provides sandboxed execution

## Future Enhancements

### Planned Features

1. **Streaming Conversion**: Convert large files incrementally
2. **Caching**: Cache conversion results for unchanged files
3. **Syntax Highlighting**: Custom Typst syntax for preview
4. **Live Preview**: Update preview on file change
5. **Batch Conversion**: Convert multiple files at once
6. **Custom Mappings**: User-defined LaTeX → Typst mappings

### Architecture Changes

- Add file watcher for auto-conversion
- Implement preview panel with webview
- Add conversion history/undo
- Support for workspaces with multiple files

## Dependencies

### Runtime Dependencies

- **VS Code API**: `vscode` module (provided by VS Code)
- **WASM Module**: `latex2typst` (built from Rust)

### Development Dependencies

- TypeScript compiler
- ESLint for linting
- VS Code Extension API types
- vsce for packaging

### Build Dependencies

- Rust toolchain (rustc, cargo)
- wasm-pack
- Node.js and npm

## File Size

- Extension code (compiled): ~50 KB
- WASM binary: ~270 KB
- Total package size: ~350 KB
- Very lightweight for a full-featured extension

## Compatibility

- **VS Code Version**: 1.85.0+
- **Node.js**: 18+
- **OS**: Windows, macOS, Linux (WASM is cross-platform)
- **Architecture**: x64, ARM64 (WASM is architecture-independent)

## Resources

- [VS Code Extension API](https://code.visualstudio.com/api)
- [WebAssembly](https://webassembly.org/)
- [wasm-bindgen](https://rustwasm.github.io/wasm-bindgen/)
- [Rust Book](https://doc.rust-lang.org/book/)
